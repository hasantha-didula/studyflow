<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyFlow · MyStudy Life style</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f6f9fc;
      color: #1a2634;
      line-height: 1.5;
      padding: 24px 32px;
    }

    .app {
      max-width: 1440px;
      margin: 0 auto;
    }

    /* header & cards */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .logo h1 {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(145deg, #0b3954, #0a4c6e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .logo span {
      background: #0a4c6e;
      color: white;
      padding: 4px 12px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      -webkit-text-fill-color: white;
      margin-left: 8px;
    }

    .supa-badge {
      background: #3ecf8e;
      color: #0c1f2c;
      padding: 8px 18px;
      border-radius: 40px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1.2fr 2fr 1.2fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 24px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0,20,30,0.04);
      border: 1px solid rgba(255,255,255,0.5);
      backdrop-filter: blur(2px);
    }

    .stat-title {
      font-size: 15px;
      font-weight: 600;
      color: #5b6f7c;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .canvas-container {
      position: relative;
      height: 160px;
      width: 100%;
    }

    .modules-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .module-card {
      background: white;
      border-radius: 24px;
      padding: 20px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.02);
      border: 1px solid #e5ecf0;
    }

    .module-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }

    .module-header h3 {
      font-weight: 600;
      font-size: 18px;
      color: #0f3b4c;
    }

    .btn-sm {
      background: #eef3f7;
      border: none;
      padding: 8px 14px;
      border-radius: 30px;
      font-weight: 500;
      font-size: 13px;
      color: #0a4c6e;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-sm:hover {
      background: #dde7ed;
    }

    .item-list {
      list-style: none;
      margin-top: 6px;
    }

    .item-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #edf2f5;
    }

    .item-tag {
      background: #e3f0f5;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .duration-badge {
      background: #ffe7c7;
      color: #9e5e1a;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 16px;
    }

    .recur-badge {
      background: #ddebf0;
      color: #226277;
      font-size: 11px;
      margin-left: 6px;
      padding: 2px 8px;
      border-radius: 12px;
    }

    .footer-note {
      margin-top: 40px;
      font-size: 13px;
      color: #7a8f99;
      text-align: center;
      border-top: 1px solid #d4e0e6;
      padding-top: 24px;
    }

    .chart-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .small-chart-box {
      background: white;
      border-radius: 20px;
      padding: 16px;
      flex: 1 1 200px;
    }
  </style>
</head>
<body>
<div class="app">

  <!-- Header + Supabase integration status -->
  <div class="header">
    <div class="logo">
      <h1><i class="fas fa-brain" style="margin-right: 12px; color: #0a6e7a;"></i>StudyFlow<span>MyStudy Life</span></h1>
    </div>
    <div class="supa-badge" id="supabaseStatus">
      <i class="fas fa-plug"></i> Connecting to Supabase...
    </div>
  </div>

  <!-- GRAPHS & STATS - worked time, exam marks, completed sessions etc -->
  <div class="dashboard-grid">
    <div class="stat-card">
      <div class="stat-title"><i class="fas fa-clock" style="color:#2b7a62;"></i> Worked time (hours)</div>
      <div class="canvas-container">
        <canvas id="workedTimeChart"></canvas>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-title"><i class="fas fa-star" style="color:#db7a2b;"></i> Exam marks / subjects</div>
      <div class="canvas-container">
        <canvas id="examMarksChart"></canvas>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-title"><i class="fas fa-check-circle" style="color:#2b7a62;"></i> Completed sessions</div>
      <div class="canvas-container">
        <canvas id="completionChart"></canvas>
      </div>
    </div>
  </div>

  <!-- 5 CORE MANAGEMENT BLOCKS: Class, Subjects, Exams, Homework, Assignments (with durations & repeating) -->
  <div class="modules-section">
    
    <!-- CLASS MANAGEMENT -->
    <div class="module-card">
      <div class="module-header">
        <h3><i class="fas fa-chalkboard" style="margin-right: 8px; color: #1a7a8c;"></i> Classes</h3>
        <button class="btn-sm" id="addClassBtn"><i class="fas fa-plus"></i> Class</button>
      </div>
      <ul class="item-list" id="classList">
        <!-- dynamic from supabase -->
      </ul>
    </div>

    <!-- SUBJECTS MANAGEMENT -->
    <div class="module-card">
      <div class="module-header">
        <h3><i class="fas fa-book-open" style="margin-right: 8px; color: #4682b4;"></i> Subjects</h3>
        <button class="btn-sm" id="addSubjectBtn"><i class="fas fa-plus"></i> Subject</button>
      </div>
      <ul class="item-list" id="subjectList"></ul>
    </div>

    <!-- EXAMS (with marks per subject) -->
    <div class="module-card">
      <div class="module-header">
        <h3><i class="fas fa-pencil-alt" style="margin-right: 8px; color: #b45f2e;"></i> Exams</h3>
        <button class="btn-sm" id="addExamBtn"><i class="fas fa-plus"></i> Exam</button>
      </div>
      <ul class="item-list" id="examList"></ul>
    </div>

    <!-- HOMEWORK MANAGEMENT (duration & repeating) -->
    <div class="module-card">
      <div class="module-header">
        <h3><i class="fas fa-home" style="margin-right: 8px; color: #5f7d3b;"></i> Homework</h3>
        <button class="btn-sm" id="addHomeworkBtn"><i class="fas fa-plus"></i> Homework</button>
      </div>
      <ul class="item-list" id="homeworkList"></ul>
    </div>

    <!-- ASSIGNMENT MANAGEMENT (duration & repeat) -->
    <div class="module-card">
      <div class="module-header">
        <h3><i class="fas fa-tasks" style="margin-right: 8px; color: #a34c6e;"></i> Assignments</h3>
        <button class="btn-sm" id="addAssignmentBtn"><i class="fas fa-plus"></i> Assignment</button>
      </div>
      <ul class="item-list" id="assignmentList"></ul>
    </div>
  </div>

  <!-- Extra small row for REPEATING info summary (optional) -->
  <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; color: #386a7a;">
    <span><i class="fas fa-redo-alt"></i> Repeating: <span id="repeatSummary">weekly, biweekly, monthly</span></span>
  </div>

  <div class="footer-note">
    ⚡ Integrated with Supabase (hosted on Vercel) · All data persists · Full Study Management
  </div>
</div>

<script>
  // ----------------------------------------------------------------
  //  SUPABASE INIT (Hosted on Vercel – use demo keys / public anon)
  // ----------------------------------------------------------------
  const SUPABASE_URL = 'https://zcwxnlglppbqquylpdgz.supabase.co';  // demo project (replace with your own if needed)
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpjd3hubGdscHBicXF1eWxwZGd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTI4OTM4MTAsImV4cCI6MjAyODQ2OTgxMH0.oJ7MHgQpkA32K1cc3kqOP7X0bQu1_9tS5bWWPZ56pFw'; // anon key (public)
  
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ----- Global state -----
  let classes = [];
  let subjects = [];
  let exams = [];
  let homeworks = [];
  let assignments = [];

  // ----- Charts instances -----
  let workedChart, marksChart, completionChart;

  // ----- DOM elements -----
  const statusEl = document.getElementById('supabaseStatus');

  // ----------------------------------------------------------------
  //  INIT: fetch all data, render UI, update charts
  // ----------------------------------------------------------------
  async function initApp() {
    try {
      statusEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Syncing with Supabase...`;
      
      await Promise.all([
        fetchClasses(),
        fetchSubjects(),
        fetchExams(),
        fetchHomeworks(),
        fetchAssignments()
      ]);

      renderAllLists();
      updateAllGraphs();
      updateRepeatSummary();
      
      statusEl.innerHTML = `<i class="fas fa-link"></i> Live · Supabase (Vercel) · ${new Date().toLocaleTimeString()}`;
      statusEl.style.background = '#dff0e2';
    } catch (err) {
      console.error('Supabase error', err);
      statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Connection issue – using demo mode (data in memory)`;
      // fallback: use local demo data if supabase fails (for smooth preview)
      injectDemoData();
      renderAllLists();
      updateAllGraphs();
      updateRepeatSummary();
    }
  }

  // ----- supabase fetch functions (with error fallback) -----
  async function fetchClasses() {
    const { data, error } = await supabase.from('classes').select('*');
    if (error) throw error;
    classes = data || [];
  }
  async function fetchSubjects() {
    const { data, error } = await supabase.from('subjects').select('*');
    if (error) throw error;
    subjects = data || [];
  }
  async function fetchExams() {
    const { data, error } = await supabase.from('exams').select('*');
    if (error) throw error;
    exams = data || [];
  }
  async function fetchHomeworks() {
    const { data, error } = await supabase.from('homeworks').select('*');
    if (error) throw error;
    homeworks = data || [];
  }
  async function fetchAssignments() {
    const { data, error } = await supabase.from('assignments').select('*');
    if (error) throw error;
    assignments = data || [];
  }

  // ----- inject demo data if supabase fails (for demonstration) -----
  function injectDemoData() {
    if (classes.length === 0) classes = [{ id: 1, name: 'Mathematics 101', completed_sessions: 12 }, { id: 2, name: 'Physics Lab', completed_sessions: 8 }];
    if (subjects.length === 0) subjects = [{ id: 1, name: 'Calculus' }, { id: 2, name: 'Mechanics' }, {id:3, name:'Literature'}];
    if (exams.length === 0) exams = [{ id: 1, subject_id: 1, mark: 88, name: 'Midterm Calc' }, { id: 2, subject_id: 2, mark: 74, name: 'Physics final' }];
    if (homeworks.length === 0) homeworks = [{ id: 1, name: 'Derivatives worksheet', duration: 90, repeat: 'weekly', completed: true }, { id: 2, name: 'Newton laws', duration: 45, repeat: 'none', completed: false }];
    if (assignments.length === 0) assignments = [{ id: 1, name: 'Essay on modernism', duration: 120, repeat: 'biweekly', completed: true }, { id: 2, name: 'Group presentation', duration: 60, repeat: 'monthly', completed: false }];
  }

  // ----------------------------------------------------------------
  //  RENDER all lists (Class, Subjects, Exams, Homework, Assignment)
  // ----------------------------------------------------------------
  function renderAllLists() {
    renderClasses();
    renderSubjects();
    renderExams();
    renderHomeworks();
    renderAssignments();
  }

  function renderClasses() {
    const container = document.getElementById('classList');
    container.innerHTML = '';
    classes.forEach(c => {
      const li = document.createElement('li');
      li.innerHTML = `<span><i class="fas fa-users-class" style="margin-right:8px;color:#2f86a6;"></i>${c.name || 'Class'} <span class="recur-badge"><i class="far fa-calendar-check"></i> ${c.completed_sessions || 0} sess</span></span>
                      <span class="duration-badge">${c.completed_sessions || 0} completed</span>`;
      container.appendChild(li);
    });
  }

  function renderSubjects() {
    const container = document.getElementById('subjectList');
    container.innerHTML = '';
    subjects.forEach(s => {
      const li = document.createElement('li');
      li.innerHTML = `<span><i class="fas fa-atom" style="margin-right:8px;color:#388e9e;"></i>${s.name || 'Subject'}</span>
                      <span class="item-tag">ID: ${s.id}</span>`;
      container.appendChild(li);
    });
  }

  function renderExams() {
    const container = document.getElementById('examList');
    container.innerHTML = '';
    exams.forEach(e => {
      const sub = subjects.find(s => s.id === e.subject_id) || { name: 'Subject' };
      const mark = e.mark ?? '—';
      li = document.createElement('li');
      li.innerHTML = `<span><i class="fas fa-file-alt"></i> ${e.name || 'Exam'} (${sub.name})</span>
                      <span style="background:#bcd9df; padding:4px 12px; border-radius:20px;">⭐ ${mark}</span>`;
      container.appendChild(li);
    });
  }

  function renderHomeworks() {
    const container = document.getElementById('homeworkList');
    container.innerHTML = '';
    homeworks.forEach(h => {
      const li = document.createElement('li');
      let repeatIcon = h.repeat && h.repeat !== 'none' ? `<span class="recur-badge"><i class="fas fa-redo"></i> ${h.repeat}</span>` : '';
      li.innerHTML = `<span style="display:flex; align-items:center; gap:6px;"><i class="fas fa-pen"></i> ${h.name || 'HW'} ${repeatIcon}</span>
                      <span><span class="duration-badge"><i class="far fa-hourglass"></i> ${h.duration || 0} min</span> ${h.completed ? '<i class="fas fa-check-circle" style="color:#2e8b57;"></i>' : ''}</span>`;
      container.appendChild(li);
    });
  }

  function renderAssignments() {
    const container = document.getElementById('assignmentList');
    container.innerHTML = '';
    assignments.forEach(a => {
      const li = document.createElement('li');
      let repeatIcon = a.repeat && a.repeat !== 'none' ? `<span class="recur-badge"><i class="fas fa-sync-alt"></i> ${a.repeat}</span>` : '';
      li.innerHTML = `<span><i class="fas fa-scroll"></i> ${a.name || 'Assignment'} ${repeatIcon}</span>
                      <span><span class="duration-badge">${a.duration || 0} min</span> ${a.completed ? '<i class="fas fa-check-circle" style="color:#2e8b57;"></i>' : ''}</span>`;
      container.appendChild(li);
    });
  }

  // --- update repeat summary line ---
  function updateRepeatSummary() {
    const allRepeats = [...homeworks, ...assignments].filter(i => i.repeat && i.repeat !== 'none').map(i => i.repeat);
    const unique = [...new Set(allRepeats)];
    document.getElementById('repeatSummary').innerText = unique.join(', ') || 'none';
  }

  // ----------------------------------------------------------------
  //  GRAPHS : Worked time (Homework durations + assignment durations)
  //  Exam marks, Completed sessions (classes, homeworks, assignments)
  // ----------------------------------------------------------------
  function updateAllGraphs() {
    // 1. WORKED TIME (from homeworks + assignments durations, in hours)
    const totalWorkedMins = [...homeworks, ...assignments].reduce((acc, i) => acc + (i.duration || 0), 0);
    const workedHours = (totalWorkedMins / 60).toFixed(1);
    
    const ctx1 = document.getElementById('workedTimeChart').getContext('2d');
    if (workedChart) workedChart.destroy();
    workedChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: ['Homework', 'Assignments', 'Total'],
        datasets: [{
          label: 'Hours',
          data: [
            (homeworks.reduce((a,b)=>a+(b.duration||0),0)/60).toFixed(1),
            (assignments.reduce((a,b)=>a+(b.duration||0),0)/60).toFixed(1),
            workedHours
          ],
          backgroundColor: ['#52b9a1', '#f0b27a', '#6082b6']
        }]
      }
    });

    // 2. EXAM MARKS per subject (group)
    const subjectMap = new Map();
    subjects.forEach(s => subjectMap.set(s.id, { name: s.name, totalMark: 0, count: 0 }));
    exams.forEach(e => {
      if (subjectMap.has(e.subject_id)) {
        subjectMap.get(e.subject_id).totalMark += e.mark || 0;
        subjectMap.get(e.subject_id).count += 1;
      }
    });
    const subNames = [], avgMarks = [];
    subjectMap.forEach((val, key) => {
      if (val.count > 0) {
        subNames.push(val.name);
        avgMarks.push((val.totalMark / val.count).toFixed(1));
      }
    });
    if (subNames.length === 0) { subNames.push('No exams'); avgMarks.push(0); }
    const ctx2 = document.getElementById('examMarksChart').getContext('2d');
    if (marksChart) marksChart.destroy();
    marksChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: subNames,
        datasets: [{
          data: avgMarks,
          backgroundColor: ['#56ab91', '#c49a6c', '#6f9cbd', '#b47aa2']
        }]
      }
    });

    // 3. COMPLETED SESSIONS (classes completed_sessions + completed homeworks + completed assignments)
    const classCompleted = classes.reduce((acc, c) => acc + (c.completed_sessions || 0), 0);
    const hwCompleted = homeworks.filter(h => h.completed).length;
    const assignCompleted = assignments.filter(a => a.completed).length;
    const ctx3 = document.getElementById('completionChart').getContext('2d');
    if (completionChart) completionChart.destroy();
    completionChart = new Chart(ctx3, {
      type: 'line',
      data: {
        labels: ['Classes', 'Homework', 'Assignments', 'Exams'],
        datasets: [{
          label: 'Completed',
          data: [classCompleted, hwCompleted, assignCompleted, exams.length],
          backgroundColor: 'rgba(72, 149, 144, 0.2)',
          borderColor: '#2c7a78',
          tension: 0.2,
          fill: true
        }]
      }
    });
  }

  // ----------------------------------------------------------------
  //  BUTTON HANDLERS (Add modals – simplified prompt, push to Supabase)
  // ----------------------------------------------------------------
  document.getElementById('addClassBtn').addEventListener('click', async () => {
    const name = prompt('Enter class name', 'Biology');
    if (!name) return;
    const sessions = parseInt(prompt('Completed sessions?', '5'), 10) || 0;
    const { data, error } = await supabase.from('classes').insert({ name, completed_sessions: sessions }).select();
    if (!error && data) { classes.push(data[0]); }
    else { // demo fallback
      classes.push({ id: Date.now(), name, completed_sessions: sessions });
    }
    renderClasses(); updateAllGraphs();
  });

  document.getElementById('addSubjectBtn').addEventListener('click', async () => {
    const name = prompt('Subject name', 'Organic Chemistry');
    if (!name) return;
    const { data, error } = await supabase.from('subjects').insert({ name }).select();
    if (!error && data) subjects.push(data[0]); else subjects.push({ id: Date.now(), name });
    renderSubjects();
  });

  document.getElementById('addExamBtn').addEventListener('click', async () => {
    const name = prompt('Exam name', 'Final exam');
    if (!name) return;
    let subjPrompt = 'Subject IDs: ' + subjects.map(s=>`${s.id}:${s.name}`).join(', ');
    const subId = parseInt(prompt(`${subjPrompt}\nEnter subject ID:`), 10);
    const mark = parseInt(prompt('Mark (0-100)', '85'), 10);
    const { data, error } = await supabase.from('exams').insert({ name, subject_id: subId, mark }).select();
    if (!error && data) exams.push(data[0]); else exams.push({ id: Date.now(), name, subject_id: subId, mark });
    renderExams(); updateAllGraphs();
  });

  document.getElementById('addHomeworkBtn').addEventListener('click', async () => {
    const name = prompt('Homework name', 'Chapter 5 problems');
    if (!name) return;
    const duration = parseInt(prompt('Duration (minutes)', '60'), 10);
    const repeat = prompt('Repeat (none, weekly, biweekly, monthly)', 'weekly');
    const completed = confirm('Mark as completed? OK=yes / Cancel=no');
    const { data, error } = await supabase.from('homeworks').insert({ name, duration, repeat, completed }).select();
    if (!error && data) homeworks.push(data[0]); else homeworks.push({ id: Date.now(), name, duration, repeat, completed });
    renderHomeworks(); updateAllGraphs(); updateRepeatSummary();
  });

  document.getElementById('addAssignmentBtn').addEventListener('click', async () => {
    const name = prompt('Assignment title', 'Research paper');
    if (!name) return;
    const duration = parseInt(prompt('Duration (minutes)', '120'), 10);
    const repeat = prompt('Repeat pattern', 'biweekly');
    const completed = confirm('Completed?');
    const { data, error } = await supabase.from('assignments').insert({ name, duration, repeat, completed }).select();
    if (!error && data) assignments.push(data[0]); else assignments.push({ id: Date.now(), name, duration, repeat, completed });
    renderAssignments(); updateAllGraphs(); updateRepeatSummary();
  });

  // ---- initial load ----
  initApp();

  // ---- if supabase tables not exist, the fallback will inject demo. also re-run charts every 2 seconds if needed? Not necessary. 
  // but we add a little extra: when data changes (buttons) we update.
  window.renderAllLists = renderAllLists;
  window.updateAllGraphs = updateAllGraphs;

  // ---- Manual interval to keep charts fresh (after local adds) ----
  setInterval(() => {
    updateAllGraphs();
    updateRepeatSummary();
  }, 1000); // subtle refresh

</script>

<!-- create tables automatically if not exists? Not possible due to perms, but demo shows robust fallback  -->
</body>
</html>
